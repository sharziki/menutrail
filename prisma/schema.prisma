// MenuTrail Multi-tenant Schema
// Each restaurant is a tenant with their own data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & TENANTS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  role          UserRole  @default(OWNER)
  
  // Supabase Auth
  supabaseId    String?   @unique
  
  // Restaurant relationship
  restaurantId  String?
  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id])
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([restaurantId])
  @@index([supabaseId])
}

enum UserRole {
  OWNER
  MANAGER
  STAFF
}

model Restaurant {
  id            String    @id @default(cuid())
  
  // Basic Info
  name          String
  slug          String    @unique  // URL-friendly name
  description   String?
  phone         String?
  email         String?
  website       String?
  
  // Branding
  logo          String?
  coverImage    String?
  primaryColor  String    @default("#f97316")
  accentColor   String    @default("#ef4444")
  
  // Address
  street        String?
  city          String?
  state         String?
  zip           String?
  country       String    @default("US")
  latitude      Float?
  longitude     Float?
  
  // API Keys (encrypted in production)
  stripeSecretKey       String?
  stripePublishableKey  String?
  stripeWebhookSecret   String?
  doordashDeveloperId   String?
  doordashKeyId         String?
  doordashSigningSecret String?
  
  // Settings
  timezone      String    @default("America/New_York")
  currency      String    @default("USD")
  taxRate       Float     @default(0.08)
  
  // Features
  onlineOrderingEnabled   Boolean @default(true)
  deliveryEnabled         Boolean @default(true)
  pickupEnabled           Boolean @default(true)
  dineInEnabled           Boolean @default(true)
  tableOrderingEnabled    Boolean @default(false)
  
  // Subscription
  plan          Plan      @default(FREE)
  planExpiresAt DateTime?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  users         User[]
  menus         Menu[]
  menuItems     MenuItem[]
  categories    Category[]
  modifierGroups ModifierGroup[]
  orders        Order[]
  customers     Customer[]
  tables        Table[]
  
  @@index([slug])
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

// ============================================
// MENU MANAGEMENT
// ============================================

model Menu {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name          String    // e.g., "Breakfast", "Lunch", "Dinner", "Happy Hour"
  description   String?
  
  // Availability
  isActive      Boolean   @default(true)
  availableFrom String?   // "06:00"
  availableTo   String?   // "11:00"
  availableDays String[]  @default(["mon", "tue", "wed", "thu", "fri", "sat", "sun"])
  
  // Layout & Theme
  layoutType    String    @default("grid")  // grid, list, card, tabs, hero, compact
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  categories    Category[]
  
  @@index([restaurantId])
}

model Category {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuId        String?
  menu          Menu?     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  
  name          String
  description   String?
  image         String?
  sortOrder     Int       @default(0)
  isActive      Boolean   @default(true)
  
  // Availability (override menu settings)
  availableFrom String?
  availableTo   String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  items         MenuItem[]
  
  @@index([restaurantId])
  @@index([menuId])
}

model MenuItem {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  categoryId    String
  category      Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name          String
  description   String?
  
  // Pricing
  price         Float
  comparePrice  Float?    // Original price for showing discounts
  
  // Images
  image         String?
  images        String[]  @default([])
  
  // Details
  calories      Int?
  prepTime      Int?      // minutes
  
  // Tags & Labels
  tags          String[]  @default([])  // popular, new, spicy, etc.
  dietaryTags   String[]  @default([])  // vegetarian, vegan, gluten-free
  allergens     String[]  @default([])
  
  // Availability
  isActive      Boolean   @default(true)
  isAvailable   Boolean   @default(true)
  sortOrder     Int       @default(0)
  
  // Inventory
  stockCount    Int?
  lowStockAlert Int?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  modifierGroups MenuItemModifierGroup[]
  orderItems    OrderItem[]
  
  @@index([restaurantId])
  @@index([categoryId])
}

// ============================================
// MODIFIERS & UPCHARGES
// ============================================

model ModifierGroup {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name          String    // e.g., "Size", "Toppings", "Sides"
  description   String?
  
  // Selection Rules
  required      Boolean   @default(false)
  minSelections Int       @default(0)
  maxSelections Int       @default(1)  // 0 = unlimited
  
  // Display
  sortOrder     Int       @default(0)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  modifiers     Modifier[]
  menuItems     MenuItemModifierGroup[]
  
  @@index([restaurantId])
}

model Modifier {
  id              String    @id @default(cuid())
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  
  name            String    // e.g., "Large", "Extra Cheese"
  price           Float     @default(0)  // Upcharge amount
  isDefault       Boolean   @default(false)
  isAvailable     Boolean   @default(true)
  sortOrder       Int       @default(0)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([modifierGroupId])
}

// Junction table for MenuItem <-> ModifierGroup
model MenuItemModifierGroup {
  id              String    @id @default(cuid())
  menuItemId      String
  menuItem        MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  sortOrder       Int       @default(0)
  
  @@unique([menuItemId, modifierGroupId])
  @@index([menuItemId])
  @@index([modifierGroupId])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Order Number
  orderNumber   String
  
  // Customer
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  customerName  String
  customerEmail String?
  customerPhone String
  
  // Order Type
  orderType     OrderType
  tableId       String?
  table         Table?    @relation(fields: [tableId], references: [id])
  
  // Delivery
  deliveryStreet       String?
  deliveryApt          String?
  deliveryCity         String?
  deliveryState        String?
  deliveryZip          String?
  deliveryInstructions String?
  
  // Pricing
  subtotal      Float
  tax           Float
  deliveryFee   Float     @default(0)
  tip           Float     @default(0)
  discount      Float     @default(0)
  total         Float
  
  // Status
  status        OrderStatus @default(PENDING)
  
  // Payment
  paymentStatus PaymentStatus @default(PENDING)
  stripeSessionId       String?
  stripePaymentIntentId String?
  
  // Delivery Tracking
  doordashDeliveryId    String?
  doordashTrackingUrl   String?
  deliveryStatus        String?
  
  // Dasher Info
  dasherName    String?
  dasherPhone   String?
  dasherVehicle String?
  
  // Timing
  estimatedReadyAt    DateTime?
  estimatedDeliveryAt DateTime?
  completedAt         DateTime?
  
  // Notes
  notes         String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  items         OrderItem[]
  
  @@index([restaurantId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

enum OrderType {
  DINE_IN
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  OUT_FOR_DELIVERY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId    String
  menuItem      MenuItem  @relation(fields: [menuItemId], references: [id])
  
  name          String
  quantity      Int
  price         Float     // Price at time of order
  
  // Modifiers
  modifiers     Json?     // [{ name: "Large", price: 2.00 }]
  modifiersTotal Float    @default(0)
  
  // Notes
  notes         String?
  
  // Total
  total         Float     // (price + modifiersTotal) * quantity
  
  @@index([orderId])
  @@index([menuItemId])
}

// ============================================
// CUSTOMERS (CRM)
// ============================================

model Customer {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Info
  name          String
  email         String?
  phone         String
  
  // Address (saved for delivery)
  street        String?
  apt           String?
  city          String?
  state         String?
  zip           String?
  
  // Stats (denormalized for performance)
  totalOrders   Int       @default(0)
  totalSpent    Float     @default(0)
  lastOrderAt   DateTime?
  
  // Notes
  notes         String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  orders        Order[]
  
  @@unique([restaurantId, phone])
  @@index([restaurantId])
}

// ============================================
// TABLE MANAGEMENT
// ============================================

model Table {
  id            String    @id @default(cuid())
  restaurantId  String
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  number        String
  section       String    @default("Main")
  capacity      Int
  
  status        TableStatus @default(AVAILABLE)
  
  // Current Session
  currentGuests Int?
  guestName     String?
  seatedAt      DateTime?
  currentTab    Float     @default(0)
  
  // QR Code
  qrCodeUrl     String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  orders        Order[]
  
  @@unique([restaurantId, number])
  @@index([restaurantId])
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
}
